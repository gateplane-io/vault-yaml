# Vault/OpenBao YAML Configuration

# PKI Secrets Engine to store an Org's CA
pki/org-ca:
  type: pki
  roles:
    # This role will be used to issue certificates
    # for Org's websites
    web:
      server_flag: true
      client_flag: false
      ttl: 7776000 # Values like '90d' create drift
      organization: ["MyOrg"]
      country: ["US"]
      locality: ["LA"]
      allowed_domains:
        - example.com
        - dev.example.com
        - staging.example.com
      access:
        - "ldap.groups.CertificateAdministrators"

  roles_conditional: # === WIP (currently unparsed) ===
    # This role can sign an employee's
    # user certificate for code signing or client auth
    client-generate:
      client_flag: true
      ttl: 365d
      organization: ["MyOrg"]
      country: ["US"]
      locality: ["LA"]
      # The CN of the Certificates must
      # follow a pattern including their LDAP username.
      # The 'email' can be a key to Vault templated strings
      # in TF.
      templated_common_name:
        - email
      key_usage:
        - DigitalSignature
        - KeyEncipherment
      access:
        # Everyone can request access for it,
        # through PolicyGate plugin
        requestors:
          - "ldap.groups.Everyone"
        # Only employee onboarders and John Doe
        # can approve access to signing such certificates
        approvers:
          - "ldap.groups.Onboarders"
          - "ldap.users.jdoe"
        # The number of minimum approvals
        # needed to provide access
        required_approvals: 2
        # Whether to provide an explanation
        # about why this kind of accessis requested
        require_justification: false

# Kubernetes

# Kubernetes Secrets Engine to generate Dynamic Credentials
# with specific K8s Roles/ClusterRoles
staging/cluster01:
  type: kubernetes
  roles:
    # 'admin' role as defined under /roles/kubernetes/admin.yaml
    admin:
      access:
        - "ldap.groups.KubernetesAdministrators"
        - "ldap.users.jdoe"
      namespaces: ["*"]
      # A TTL of 10 minutes is the lowest possible for ServiceAccounts
      ttl: 600
      ttl_max: 3600
    # Developers can deploy to only 3 Namespaces
    deployer:
      access:
        - "ldap.groups.Developers"
      namespaces:
        - application
        - stress-test1
        - playground
    bot-deploy:
      access:
        # === WIP (currently unparsed) ===
        # This can be a GitHub Workflow
        # authenticated to vault through Github Token
        - "oidc.github-cicd.org/repository"
      namespaces: ["application"]
  roles_conditional:
    admin:
      namespaces: ["*"]
      ttl: 600
      ttl_max: 3600
      access:
        # Developers can also claim temporary access to 'admin' role
        # (e.g for hotfixes, routine maintainance)
        requestors:
          - "ldap.groups.Developers"
        # If approved by current administrators
        # or by the Change Advisory Board (CAB)
        approvers:
          - "ldap.groups.KubernetesAdministrators"
          - "ldap.users.jdoe"
          - "ldap.groups.cab"
        # Need to provide a reason for access,
        # (e.g a ticket ID, Slack conversation link, etc)
        require_justification: true

# SSH CA

# SSH CA Secrets Engine that signs temporary SSH keys
# with SSH Extensions
staging/vms:
  type: ssh
  roles:
    developer:
      access:
        - "ldap.groups.Developers"
      extensions:
        # Only allow port-forwarding
        # (no TTY, just tunnel traffic)
        - permit-port-forwarding
    admin:
      access:
        - "ldap.groups.Administrators"
        - "ldap.users.jdoe"
      extensions:
        # All possible extensions
        - permit-pty
        - permit-port-forwarding
        - permit-agent-forwarding
        - permit-user-rc
        - permit-X11-forwarding

# ===============
# Ad-hoc Policies

# The 'adhoc' block is used to directly create arbitrary
# Vault Policies from template files located under 'roles/vault'.
adhoc:
  type: vault
  roles:
    # Role names are the file names of the templates
    secrets-personal:
      access:
        # This policy will be added to everyone
        - "ldap.groups.Everyone"
    secrets-group:
      access:
        # Every group will have a copy of this policy
        - "ldap.groups.Administrators"
        - "ldap.groups.Everyone"
        - "ldap.groups.CertificateAdministrators"
      # Create and attach a templated policy for each membership
      # (and not one policy to all members)
      for_each: true
